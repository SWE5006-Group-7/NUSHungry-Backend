name: CI Pipeline

on:
  push:
    branches: [ "main", "microservice/**" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # Matrix build for all microservices
  microservices-test:
    runs-on: ubuntu-latest
    environment: dev
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: admin-service
            port: 8082
            db: postgres
            db_port: 5432
          - name: cafeteria-service
            port: 8083
            db: postgres
            db_port: 5433
          - name: media-service
            port: 8085
            db: postgres
            db_port: 5434
          - name: preference-service
            port: 8086
            db: postgres
            db_port: 5435
          - name: review-service
            port: 8084
            db: mongodb
            db_port: 27017
          - name: gateway-service
            port: 8080
            db: none
            db_port: 0
          - name: eureka-server
            port: 8761
            db: none
            db_port: 0
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Setup PostgreSQL (if needed)
        if: matrix.service.db == 'postgres'
        run: |
          docker run -d \
            --name ${{ matrix.service.name }}-postgres \
            -e POSTGRES_DB=${{ matrix.service.name }}_db \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }} \
            -p ${{ matrix.service.db_port }}:5432 \
            postgres:15

      - name: Setup MongoDB (if needed)
        if: matrix.service.db == 'mongodb'
        run: |
          docker run -d \
            --name ${{ matrix.service.name }}-mongodb \
            -e MONGO_INITDB_ROOT_USERNAME=admin \
            -e MONGO_INITDB_ROOT_PASSWORD=${{ secrets.MONGO_PASSWORD }} \
            -p ${{ matrix.service.db_port }}:27017 \
            mongo:7

      - name: Setup RabbitMQ (for services that need it)
        if: matrix.service.name == 'admin-service' || matrix.service.name == 'cafeteria-service' || matrix.service.name == 'review-service'
        run: |
          docker run -d \
            --name rabbitmq \
            -p 5672:5672 \
            -p 15672:15672 \
            rabbitmq:3-management

      - name: Wait for database
        run: sleep 10

      - name: Run tests for ${{ matrix.service.name }}
        working-directory: ${{ matrix.service.name }}
        run: mvn test jacoco:report

      - name: Cleanup
        if: always()
        run: |
          docker rm -f ${{ matrix.service.name }}-postgres || true
          docker rm -f ${{ matrix.service.name }}-mongodb || true
          docker rm -f rabbitmq || true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.service.name }}
          path: |
            ${{ matrix.service.name }}/target/surefire-reports/
            ${{ matrix.service.name }}/target/site/jacoco/
          retention-days: 7
  sast:
    runs-on: ubuntu-latest
    environment: dev
    strategy:
      fail-fast: false
      matrix:
        service: [admin-service, cafeteria-service, media-service, preference-service, review-service, gateway-service, eureka-server]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Check code quality for ${{ matrix.service }}
        working-directory: ${{ matrix.service }}
        run: mvn compile spotbugs:check site

      - name: Upload SAST results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sast-results-${{ matrix.service }}
          path: ${{ matrix.service }}/target/site/*.html
  owasp-dependency-check:
    runs-on: ubuntu-latest
    environment: dev
    strategy:
      fail-fast: false
      matrix:
        service: [admin-service, cafeteria-service, media-service, preference-service, review-service, gateway-service, eureka-server]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Dependency scan for ${{ matrix.service }}
        working-directory: ${{ matrix.service }}
        run: mvn compile dependency-check:check -DnvdApiKey=${{ secrets.NVD_API_KEY }} -DfailBuildOnCVSS=11 -Dformats=HTML
        continue-on-error: true

      - name: Upload dependency scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: owasp-dependency-scan-results-${{ matrix.service }}
          path: ${{ matrix.service }}/target/dependency-check-report.html
  check-style:
    runs-on: ubuntu-latest
    environment: dev
    strategy:
      fail-fast: false
      matrix:
        service: [admin-service, cafeteria-service, media-service, preference-service, review-service, gateway-service, eureka-server]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Check code style for ${{ matrix.service }}
        working-directory: ${{ matrix.service }}
        run: mvn compile checkstyle:checkstyle
      - name: Upload check style results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: check-style-results-${{ matrix.service }}
          path: ${{ matrix.service }}/target/reports/checkstyle.html
  container-scan:
    environment: dev
    runs-on: ubuntu-latest
    needs: ["microservices-test", "sast", "owasp-dependency-check", "check-style"]
    strategy:
      fail-fast: false
      matrix:
        service: [admin-service, cafeteria-service, media-service, preference-service, review-service, gateway-service, eureka-server]
    steps:
      - uses: actions/checkout@v4
      - uses: snyk/actions/setup@master
      - uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Package ${{ matrix.service }}
        working-directory: ${{ matrix.service }}
        run: mvn package -DskipTests
      - name: Build image for scanning
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          docker build -t ${{ matrix.service }}:test -f ${{ matrix.service }}/Dockerfile ${{ matrix.service }}
          docker image ls
          snyk container test ${{ matrix.service }}:test --file=${{ matrix.service }}/Dockerfile --severity-threshold=high --fail-on=upgradable
        continue-on-error: true